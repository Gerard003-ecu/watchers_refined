<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <title>Atomic Piston Playground</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <style>
    :root {
      --bg: #111827;
      --card: #1f2937;
      --accent: #3b82f6;
      --text: #e5e7eb;
    }
    body { margin: 0; font-family: system-ui, sans-serif; background: var(--bg); color: var(--text); }
    header { text-align: center; padding: 2rem 1rem; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 1.5rem; padding: 1rem; }
    .card { background: var(--card); border-radius: 8px; padding: 1.2rem; display: flex; flex-direction: column; }
    h3 { margin-top: 0; color: var(--accent); }
    label { margin: .3rem 0 .1rem; font-size: .9rem; }
    input[type=range] { width: 100%; }
    button { margin-top: .5rem; padding: .5rem 1rem; border: none; border-radius: 4px; background: var(--accent); color: #fff; cursor: pointer; }
    .output { flex: 1; font-family: monospace; overflow: auto; max-height: 180px; background: #0003; padding: .5rem; border-radius: 4px; margin-top: .5rem; }
  </style>
</head>
<body>
<header>
  <h1><i class="fas fa-cog"></i> Atomic Piston Playground</h1>
  <p>Interactive demonstrations powered by <code>atomic_piston_v2.py</code> (server-side)</p>
</header>

<section class="grid">
  <!-- 1. Circuit Equivalent -->
  <div class="card">
    <h3>Circuit Equivalent</h3>
    <label>Capacitance (F)</label>
    <input type="range" min="0.1" max="10" step="0.1" value="1" id="cap"/>
    <label>Inductance (H)</label>
    <input type="range" min="0.1" max="10" step="0.1" value="1" id="ind"/>
    <label>Resistance (Ω)</label>
    <input type="range" min="0.1" max="100" step="1" value="10" id="res"/>
    <button onclick="calcCircuit()">Compute</button>
    <div id="circuit-out" class="output"></div>
  </div>

  <!-- 2. Capacitor Mode -->
  <div class="card">
    <h3>Capacitor Discharge</h3>
    <button onclick="fireCapacitor()">Trigger Pulse</button>
    <div id="capacitor-out" class="output"></div>
  </div>

  <!-- 3. Battery Mode -->
  <div class="card">
    <h3>Battery Mode</h3>
    <label>Discharge Rate (%/s)</label>
    <input type="range" min="1" max="10" value="5" id="bat-rate"/>
    <button onclick="toggleBattery()">Start / Stop</button>
    <div id="battery-out" class="output"></div>
  </div>

  <!-- 4. Step Response -->
  <div class="card">
    <h3>Step Response</h3>
    <label>Force (N)</label>
    <input type="range" min="0" max="50" value="10" id="step-force"/>
    <label>Duration (s)</label>
    <input type="range" min="0.5" max="10" step="0.5" value="2" id="step-dur"/>
    <button onclick="runStep()">Simulate</button>
    <canvas id="step-canvas" width="300" height="180"></canvas>
  </div>

  <!-- 5. Impulse Response -->
  <div class="card">
    <h3>Impulse Response</h3>
    <label>Impulse (N·s)</label>
    <input type="range" min="0" max="5" step="0.1" value="1" id="impulse-mag"/>
    <button onclick="runImpulse()">Simulate</button>
    <canvas id="impulse-canvas" width="300" height="180"></canvas>
  </div>

  <!-- 6. Bode Plot -->
  <div class="card">
    <h3>Bode Plot</h3>
    <label>Start Freq (Hz)</label>
    <input type="range" min="0.01" max="1" step="0.01" value="0.1" id="bode-start"/>
    <label>End Freq (Hz)</label>
    <input type="range" min="1" max="100" step="1" value="10" id="bode-end"/>
    <button onclick="drawBode()">Generate</button>
    <canvas id="bode-canvas" width="300" height="180"></canvas>
  </div>
</section>

<script>
/* ---------- Helper: call backend ---------- */
async function api(method, params = {}) {
  const url = `/api/${method}?${new URLSearchParams(params)}`;
  const r = await fetch(url);
  return r.json();
}

/* ---------- 1. Circuit Equivalent ---------- */
function calcCircuit() {
  const C = document.getElementById('cap').value;
  const L = document.getElementById('ind').value;
  const R = document.getElementById('res').value;
  api('circuit', {C, L, R}).then(res => {
    document.getElementById('circuit-out').textContent =
      `Resonant freq: ${res.f0.toFixed(2)} Hz\nQ factor: ${res.Q.toFixed(2)}`;
  });
}

/* ---------- 2. Capacitor Mode ---------- */
function fireCapacitor() {
  api('capacitor_fire').then(res => {
    document.getElementById('capacitor-out').textContent =
      `Pulse amplitude: ${res.amplitude.toFixed(2)} m\nDuration: ${res.duration.toFixed(3)} s`;
  });
}

/* ---------- 3. Battery Mode ---------- */
let batteryInterval = null;
function toggleBattery() {
  const btn = event.target;
  if (batteryInterval) {
    clearInterval(batteryInterval);
    batteryInterval = null;
    btn.textContent = 'Start';
    api('battery_stop');
  } else {
    const rate = document.getElementById('bat-rate').value;
    api('battery_start', {rate});
    batteryInterval = setInterval(() => {
      api('battery_status').then(res => {
        document.getElementById('battery-out').textContent =
          `Discharging: ${res.remaining.toFixed(2)} % left`;
      });
    }, 1000);
    btn.textContent = 'Stop';
  }
}

/* ---------- 4. Step Response ---------- */
async function runStep() {
  const force = document.getElementById('step-force').value;
  const dur  = document.getElementById('step-dur').value;
  const data = await api('step', {force, duration: dur, dt: 0.01});
  drawTimePlot('step-canvas', data.time, data.position, 'Position (m)');
}

/* ---------- 5. Impulse Response ---------- */
async function runImpulse() {
  const mag = document.getElementById('impulse-mag').value;
  const data = await api('impulse', {magnitude: mag, duration: 5, dt: 0.01});
  drawTimePlot('impulse-canvas', data.time, data.position, 'Position (m)');
}

/* ---------- 6. Bode Plot ---------- */
async function drawBode() {
  const f0 = parseFloat(document.getElementById('bode-start').value);
  const f1 = parseFloat(document.getElementById('bode-end').value);
  const freq = [];
  for (let f = f0; f <= f1; f *= 1.2) freq.push(f);
  const data = await api('bode', {freq});
  drawBodePlot('bode-canvas', data.frequencies, data.magnitude, data.phase);
}

/* ---------- Canvas helpers ---------- */
function drawTimePlot(canvasId, t, y, yLabel) {
  const cvs = document.getElementById(canvasId);
  const ctx = cvs.getContext('2d');
  ctx.clearRect(0,0,cvs.width,cvs.height);
  ctx.strokeStyle='#3b82f6';
  ctx.beginPath();
  const dx = cvs.width / t.length;
  const scale = cvs.height / (Math.max(...y) - Math.min(...y) || 1);
  y.forEach((v,i)=>ctx.lineTo(i*dx, cvs.height/2 - v*scale));
  ctx.stroke();
}

function drawBodePlot(canvasId, f, mag, phase) {
  const cvs = document.getElementById(canvasId);
  const ctx = cvs.getContext('2d');
  ctx.clearRect(0,0,cvs.width,cvs.height);
  ctx.strokeStyle='#3b82f6';
  ctx.beginPath();
  const dx = cvs.width / f.length;
  mag.forEach((v,i)=>ctx.lineTo(i*dx, cvs.height - (v+60)*1.5));
  ctx.stroke();
}
</script>
</body>
</html>
